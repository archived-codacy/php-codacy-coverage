#!/usr/bin/env php
<?php

$files = array(
    __DIR__ . "/../../vendor/autoload.php",
    __DIR__ . "/../../../autoload.php",
    dirname(__DIR__) . "/vendor/autoload.php"
);

$found = false;
foreach ($files as $file) {
    if (file_exists($file)) {
        require_once $file;
        $found = true;
        break;
    }
}

if (!$found) {
    die(
      "You need to set up the project dependencies using the following commands:" . PHP_EOL .
      "curl -s http://getcomposer.org/installer | php" . PHP_EOL .
      "php composer.phar install" . PHP_EOL
    );
}

use Codacy\Coverage\Parser\CloverParser;
use Codacy\Coverage\Parser\PhpUnitXmlParser;
use Codacy\Coverage\Util\CodacyApiClient;
use Codacy\Coverage\Util\GitClient;
use Codacy\Coverage\Util\JsonProducer;

$projectToken = getenv("CODACY_PROJECT_TOKEN");

if ($projectToken == false) {
    die(
        "Cannot continue with execution as long as your project token is not set as an environmental variable." . PHP_EOL .
        "Please type: export CODACY_PROJECT_TOKEN=<YOUR TOKEN>" . PHP_EOL
    );
}

if (sizeof($argv) != 2) {
    die("Invalid length of arguments. Only one argument for coverage format allowed." . PHP_EOL .
        "It should either be clover or phpunit." . PHP_EOL . "## Example: php vendor/bin/codacycoverage clover" . PHP_EOL .
        "Or if you are using the phar, codacycoverage.phar clover" . PHP_EOL
    );
} else {
    $coverageFormat = $argv[1];
}

switch ($coverageFormat) {

    case "clover":
        $parser = new CloverParser(
            join(DIRECTORY_SEPARATOR, array("build", "logs", "clover.xml"))
        );
        break;

    case "phpunit":
        $parser = new PhpUnitXmlParser(
            join(DIRECTORY_SEPARATOR, array("build", "coverage-xml", "index.xml"))
        );
        $parser->setDirOfFileXmls(join(DIRECTORY_SEPARATOR, array("build", "coverage-xml")));
        break;

    default:
        throw new \InvalidArgumentException(
            'No valid coverage format argument found. It should either be clover or phpunit.' . PHP_EOL .
            "Example: php vendor/bin/codacycoverage clover"
        );
}

$jsonProducer = new JsonProducer();

$jsonProducer->setParser($parser);

$data = $jsonProducer->makeJson();

$gClient = new GitClient(getcwd());

$commit = $gClient->getHashOfLatestCommit();

$baseUrl = getenv("CODACY_API_BASE_URL");

if ($baseUrl == false) {
    $baseUrl = "https://www.codacy.com";
}

$url = $baseUrl . "/api/coverage/" . $projectToken . "/" . $commit;

CodacyApiClient::postData($url, $data);
